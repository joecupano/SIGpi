#!/bin/bash

###
### SIGpi
###
### pkg_sdrangelsrv
###
###

case "$1" in 
    remove )
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##   Remove SDRangel Server"
        echo -e "${SIGPI_BANNER_RESET}"

        sudo dpkg -r sdrangelsrv
        sed -i /sdrangelsrv/d $SIGPI_CONFIG
        rm $HOME/.config/f4exb/fftw-wisdom
        rm $HOME/.local/share/f4exb/SDRangel/fftw-wisdom

        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##   SDRangel Server Removed"
        echo -e "${SIGPI_BANNER_RESET}"
        ;;
    purge )
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##   Purge SDRangel Server"
        echo -e "${SIGPI_BANNER_RESET}"

        sudo dpkg -P sdrangelsrv
        sed -i /sdrangelsrv/d $SIGPI_CONFIG
        rm $HOME/.config/f4exb/fftw-wisdom
        rm $HOME/.local/share/f4exb/SDRangel/fftw-wisdom

        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##   SDRangel Server Purged"
        echo -e "${SIGPI_BANNER_RESET}"
        ;;
    install )
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##"
        echo -e "${SIGPI_BANNER_COLOR} ##   Install SDRangel Server"
        echo -e "${SIGPI_BANNER_COLOR} ##"
        echo -e "${SIGPI_BANNER_RESET}"
        
        ## DEPENDENCIES
        sudo apt-get install -y libfftw3-dev
        sudo apt-get install -y libusb-1.0-0-dev
        sudo apt-get install -y libusb-dev
        sudo apt-get install -y libboost-all-dev
        sudo apt-get install -y libasound2-dev
        sudo apt-get install -y libgl1-mesa-dev 
        sudo apt-get install -y gettext
        sudo apt-get install -y pulseaudio
        sudo apt-get install -y libopencv-dev
        sudo apt-get install -y libxml2-dev
        sudo apt-get install -y bison
        sudo apt-get install -y flex
        sudo apt-get install -y ffmpeg
        sudo apt-get install -y libavcodec-dev
        sudo apt-get install -y libavformat-dev
        sudo apt-get install -y opus-tools
        sudo apt-get install -y libopus-dev
        sudo apt-get install -y qml-module-qtlocation
        sudo apt-get install -y qml-module-qtpositioning
        sudo apt-get install -y qml-module-qtquick-window2
        sudo apt-get install -y qml-module-qtquick-dialogs
        sudo apt-get install -y qml-module-qtquick-controls
        sudo apt-get install -y qml-module-qtquick-layouts
        
        ## PACKAGE
        cd $SIGPI_PACKAGES        
        if [[ "$SIGPI_HWARCH" == "x86_64" ]]; then
	        cd $SIGPI_DEBS
	        sudo dpkg -i sdrangelsrv_current_amd64.deb
        fi

        if [[ "$SIGPI_HWARCH" == "aarch64" ]]; then
	        cd $SIGPI_DEBS
	        sudo dpkg -i sdrangelsrv_current_arm64.deb
        fi
        echo "sdrangelsrv" >> $SIGPI_CONFIG 
        
        ### FFTW-WISDOM CHECK AND LINK
        mkdir $HOME/.config/f4exb
        mkdir $HOME/.local/share/f4exb
        mkdir $HOME/.local/share/f4exb/SDRangel
        if [ ! -f "$SIGPI_ETC/fftw-wisdom" ]; then
            fftwf-wisdom -v -n -o $SIGPI_ETC/fftw-wisdom 128 256 512 1024 2048 4096 8192 16384 32768
        fi
        cp $SIGPI_ETC/fftw-wisdom $HOME/.local/share/f4exb/SDRangel/fftw-wisdom
        cp $SIGPI_ETC/fftw-wisdom $HOME/.config/f4exb/SDRangel/fftw-wisdom

        ## DESKTOP
	    # Add Icon
        # Add Desktop
        # Change Category
        # Add to Menu
      
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##   SDRangel Server Installed"
        echo -e "${SIGPI_BANNER_RESET}"
        ;;
    build )
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##"
        echo -e "${SIGPI_BANNER_COLOR} ##   Build SDRangel Server"
        echo -e "${SIGPI_BANNER_COLOR} ##"
        echo -e "${SIGPI_BANNER_RESET}"
        
        ## DEPENDENCIES
        sudo apt-get install -y libfftw3-dev
        sudo apt-get install -y libusb-1.0-0-dev
        sudo apt-get install -y libusb-dev
        sudo apt-get install -y libboost-all-dev
        sudo apt-get install -y libasound2-dev
        sudo apt-get install -y libgl1-mesa-dev 
        sudo apt-get install -y gettext
        sudo apt-get install -y pulseaudio
        sudo apt-get install -y libopencv-dev
        sudo apt-get install -y libxml2-dev
        sudo apt-get install -y bison
        sudo apt-get install -y flex
        sudo apt-get install -y ffmpeg
        sudo apt-get install -y libavcodec-dev
        sudo apt-get install -y libavformat-dev
        sudo apt-get install -y opus-tools
        sudo apt-get install -y libopus-dev
        sudo apt-get install -y qml-module-qtlocation
        sudo apt-get install -y qml-module-qtpositioning
        sudo apt-get install -y qml-module-qtquick-window2
        sudo apt-get install -y qml-module-qtquick-dialogs
        sudo apt-get install -y qml-module-qtquick-controls
        sudo apt-get install -y qml-module-qtquick-layouts
        
        ## PACKAGE
        cd $SIGPI_SOURCE
        git clone https://github.com/f4exb/sdrangel.git
        cd sdrangel
        #git reset --hard 7b85db4  # v7.15.4
        #git reset --hard 513c0e5  # v7.16.0
        #git reset --hard c9075d4  # v7.17.0
        #git reset --hard cdcb73f  # v7.17.1
        #git reset --hard 78068fd  # v7.17.2
        git reset --hard 5dcf7f7   # v7.17.3
        mkdir build && cd build
        cmake .. -Wno-dev -DBUILD_GUI=off
        make -j4
        sudo checkinstall --install=no
        sudo mv *.deb $SIGPI_DEBS
        
        ## DESKTOP
	    # Add Icon
        # Add Desktop
        # Change Category
	    # Add to Menu
      
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##   SDRangel Server Built. Debian package available in $SIGPI_DEBS""
        echo -e "${SIGPI_BANNER_RESET}"
        ;;
    * )
        echo -e "${SIGPI_BANNER_COLOR}"
        echo -e "${SIGPI_BANNER_COLOR} ##  ERROR: Unkown action or package"
        echo -e "${SIGPI_BANNER_RESET}"
        ;;
esac
